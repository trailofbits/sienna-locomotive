""" Module handling !exploitable
    !exploitable dll (MSEC.dll) has to be installed in
    DEBUG_PATH\\winext

    Example:
        - "C:\\Program Files\\Windows Kits\\10\\Debuggers\\x86\\winext"
        - "C:\\Program Files\\Windows Kits\\10\\Debuggers\\x64\\winext"
    """

import subprocess
import os

import autoit.autoit as autoit
import autoit.autoit_lib as autoit_lib

WINGDB_PATH = ""
# cdb.exe: user mode debuger with command line interface
DEBUG = "cdb.exe"

# Run the program, load the MSEC dll, run !exploitable and quit
WINGDB_CMD = r"g;!load winext\MSEC.dll;!exploitable;q"

def init(config_system):
    """
    Initialize the module

    Args:
        config_system (dict): The system configuration
    """

    global WINGDB_PATH
    autoit.init(config_system)
    WINGDB_PATH = config_system['path_windbg']

def run(path_program, program_name, parameters):
    """
    Run !exploitable

    Args:
        path_program (string): path the to the program
        program_name (string): name of the program
        parameters (string list): parameters of the script
    Returns:
        string: exploitability verdict
    """
    cmd = [WINGDB_PATH + DEBUG, "-c", WINGDB_CMD,
           os.path.join(path_program, program_name)] + parameters
    print cmd
    proc = subprocess.Popen(cmd, stdout=subprocess.PIPE,
                            stderr=subprocess.PIPE)
    classification = "Not found"
    for line in iter(proc.stdout.readline, b''):
        # detect when !exploitable analysis starts
        print line
        if line.startswith("!exploitable "):
            break
    for line in iter(proc.stdout.readline, b''):
        if line.startswith("Exploitability Classification:"):
            classification = line.rstrip()[30:]
    proc.wait()
    return classification


def run_autoit(autoit_script, path_program, program_name, parameters):
    """
    Run !exploitable with an auto it script

    Args:
        autoit_script (string): path the to script
        path_program (string): path the to the program
        program_name (string): name of the program
        parameters (string list): parameters of the script
    Returns:
        string: exploitability verdict
    """
    cmd = [WINGDB_PATH + DEBUG, "-c", WINGDB_CMD,
           os.path.join(path_program, program_name)] + parameters
    proc = subprocess.Popen(cmd, stdout=subprocess.PIPE,
                            stderr=subprocess.PIPE)

    autoit_script = autoit_lib.get_autoit_path(autoit_script, "exploitable")
    autoit.run(autoit_script, parameters)

    classification = "Not found"
    for line in iter(proc.stdout.readline, b''):
        # detect when !exploitable analysis starts
        print line
        if line.startswith("!exploitable "):
            break
    for line in iter(proc.stdout.readline, b''):
        if line.startswith("Exploitability Classification:"):
            classification = line.rstrip()[30:]
    proc.wait()
    return classification
