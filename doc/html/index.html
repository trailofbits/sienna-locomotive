<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.14"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Sienna Locomotive 2: Sienna Locomotive 2</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">Sienna Locomotive 2
   </div>
   <div id="projectbrief">SL2</div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.14 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
var searchBox = new SearchBox("searchBox", "search",false,'Search');
/* @license-end */
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
$(function() {
  initMenu('',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
/* @license-end */</script>
<div id="main-nav"></div>
</div><!-- top -->
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<div class="header">
  <div class="headertitle">
<div class="title">Sienna Locomotive 2 </div>  </div>
</div><!--header-->
<div class="contents">
<div class="textblock"><p>Sienna Locomotive is a fuzzing and crash triage system with usability features that are intended to attract a wider user base than conventional fuzzing tools. The goal is to bring all the power that software fuzzing has to offer into the hands of less-experienced users. Focusing on ease of use won't stop us from trying to make it smarter and faster than the competition.</p>
<h2>Getting Started</h2>
<h3>The project</h3>
<p>Skim the following documents to familiarize yourself with the project:</p><ul>
<li>Watch the <a href="https://drive.google.com/open?id=1njGgRrrfNanYSuaMy5nwLi1rw2bS1rMt">Demo video</a></li>
<li><a href="https://docs.google.com/document/d/1zTUHlu-y_ZLT08saJp0qguYXC69F6CskMPZVLs48IVc/edit">Interim Technical Report</a></li>
<li><a href="https://docs.google.com/document/d/1RwvknJk9PPgecLcsQI1SiXje9SdKB3OuOoSniIDvy68/edit">SL2 Reinception Doc</a></li>
<li>harness.py (if you're familiar with Python)</li>
<li>Read through the <a href="https://github.com/trailofbits/sienna-locomotive/projects/6">Projects</a> and <a href="https://github.com/trailofbits/sienna-locomotive/issues">Issues</a> pages on GitHub</li>
</ul>
<h2>High level architecture</h2>
<div class="fragment"><div class="line">Wizard</div><div class="line">  Run the target program once</div><div class="line">  Find all the functions the fuzzer can target</div><div class="line">  Return a list the user can select from</div><div class="line"></div><div class="line">Fuzzing harness</div><div class="line">  Run the target program</div><div class="line">  Hook attack surface functions</div><div class="line">  Execute program with mutated inputs</div><div class="line">  Catch crashes for tracer</div><div class="line"></div><div class="line">Triage</div><div class="line">  Traces and performs taint tracking on a crashing execution</div><div class="line">  Combines data about crash, inputs, and taint</div><div class="line">  Output score and JSON info about crash</div><div class="line"></div><div class="line">Mutation Server</div><div class="line">  Sent bytes by fuzzing harness</div><div class="line">  Figures out mutations for bytes</div><div class="line">  Sends back mutations</div><div class="line">  Responsible for logging information about corrupted inputs</div><div class="line"></div><div class="line">Python harness</div><div class="line">  Handles user input and configuration</div><div class="line">  Runs all the other components</div></div><!-- fragment --><h3>Building</h3>
<p>First, clone the repository: <code>git clone <a href="https://github.com/trailofbits/sienna-locomotive.git">https://github.com/trailofbits/sienna-locomotive.git</a></code> (or download a zip)</p>
<h4>Dependencies</h4>
<p>Next, install the following dependencies</p><ul>
<li><a href="https://cmake.org/download/">CMake</a></li>
<li>Visual Studio 2017 (Install components for Windows Console dev)</li>
<li>DynamoRIO (Automatically installed with make.ps1)</li>
<li>Python (3.6+)</li>
</ul>
<h4>Build Commands</h4>
<p>Then, from the root of the Sienna Locomotive repository: In powershell, run make.ps1:</p>
<p><code>PS C:\proj\sl2\sienna-locomotive&gt; .\make.ps1</code></p>
<p>This should download and install DynamoRIO in the sienna-locomotive directive if it does not already exist. It will then compile the project.</p>
<p>If you're not familiar with cmake - the first invocation configures it, the second compiles the project. To recompile, just run the final command again.</p>
<p>You might need to use the Visual Studio Developer Command Prompt in order for cmake to be able to see the VS compiler.</p>
<p>Use <code>.\make.ps1 clean</code> for a clean build .</p>
<p>Usage <code>make.ps1 help</code> for more info.</p>
<div class="fragment"><div class="line">PS C:\proj\sl2\sienna-locomotive&gt; .\make.ps1 help</div><div class="line">Usage: make1.ps [clean|dep|reconfig|help]</div><div class="line"></div><div class="line">make1.ps without any options will build</div><div class="line"></div><div class="line">clean</div><div class="line">    Cleans build directory and configuration (reconfigs)</div><div class="line"></div><div class="line">dep</div><div class="line">    Rebuild dependencies</div><div class="line"></div><div class="line">reconfig</div><div class="line">    Deletes fuzzkit directory with run configuration</div><div class="line"></div><div class="line">help</div><div class="line">    This info</div></div><!-- fragment --><h3>Configuring</h3>
<p>Open up powershell in the project root and run harness.py for the first time.</p>
<p><code>PS C:\proj\sl2\sienna-locomotive&gt; python .\harness.py</code></p>
<p>:warning: Python version 3 is required, although on some systems this could be <code>python.exe</code> or <code>python3.exe</code> .</p>
<p>It'll create a default configuration file in <code>APPDATA\Trail of Bits\fuzzkit\</code>. You can leave everything in there and it will work, but you might want to update the file paths to be relative to C: so that you can invoke it from anywhere. If you want to create a new profile, just copy the default one and change the name. Then you can use the <code>-p</code> flag to harness.py to change which profile it pulls settings from.</p>
<p>Using -h on the harness will print out the list of command line options it supports. You can set a number of things permanently by adding lines to the configuration file. As a general rule though, the command line parameters will overwrite what's in the config file if you explicitly pass them in. This isn't the case for everything, so if a command isn't working the way you expect, run fuzzer_config.py with the same arguments to see exactly what settings are getting passed to the harness.</p>
<h3>Running</h3>
<h4>Via the GUI</h4>
<p><code>python3 gui.py</code> will run the Qt frontend for the fuzzer. While it provides a convenient way of invoking the components, it doesn't provide as many configuration options. Fortunately, it accepts most of the same command line arguments as the harness, so you can simply pass these in when you invoke the GUI. For example: <code>python3 gui.py -f 15 -i 360</code> will run the gui such that it invokes the fuzzer with a timeout of 15 seconds for each fuzzing run and a timeout of 360 seconds for each triage run. However, it does NOT respect the -e flag, nor any of the flags that would be overwritten from the config file if invoked on the harness.</p>
<h4>Via the harness</h4>
<p><code>python3 harness.py</code> will run the test application in fuzzing mode. By default, the test application will crash after a few fuzzing attempts, so if it doesn't do so when you need it to, you can pass <code>-a 0</code> to the harness (as the last argument) and it will crash every time. Play around with the command flags to see what else you can do.</p>
<h4>To run individual components manually</h4>
<p>From the root of the project - </p><div class="fragment"><div class="line"># General Pattern:</div><div class="line">.\dynamorio\bin64\drrun.exe -c build\client_name\Debug\client.dll [client_args] -- C:\path\to\target_application [target_args]</div><div class="line"></div><div class="line"># triage</div><div class="line">.\dynamorio\bin64\drrun.exe -c build\tracer_dynamorio\Debug\tracer.dll -- corpus\win_asm\crashes.exe 7</div><div class="line"></div><div class="line"># wizard</div><div class="line">.\dynamorio\bin64\drrun.exe -c build\wizard\Debug\wizard.dll -- build\corpus\test_application\Debug\test_application.exe 0</div><div class="line"></div><div class="line"># server</div><div class="line">build\server\Debug\server.exe</div><div class="line"></div><div class="line"># fuzzer</div><div class="line">.\dynamorio\bin64\drrun.exe -c build\fuzz_dynamorio\Debug\fuzzer.dll -- build\corpus\test_application\Debug\test_application.exe 0 -f</div><div class="line"></div><div class="line"># triage crash</div><div class="line">.\dynamorio\bin64\drrun.exe -c sienna-locomotive\build\tracer_dynamorio\Debug\tracer.dll -r [RUN_ID] -- build\corpus\test_application\Debug\test_application.exe 0 -f</div><div class="line"></div><div class="line"># targeting</div><div class="line">.\dynamorio\bin64\drrun.exe -c build\fuzz_dynamorio\Debug\fuzzer.dll -t 0,ReadFile -- build\corpus\test_application\Debug\test_application.exe 0 -f</div><div class="line"></div><div class="line">.\dynamorio\bin64\drrun.exe -c build\tracer_dynamorio\Debug\tracer.dll -r [RUN_ID] -t 0,ReadFile -- build\corpus\test_application\Debug\test_application.exe 0 -f</div></div><!-- fragment --><p>#### Regression Test </p><div class="fragment"><div class="line">python.exe .\regress.py</div><div class="line">test_main (__main__.Test1) ... ok</div><div class="line"></div><div class="line">----------------------------------------------------------------------</div><div class="line">Ran 1 test in 0.906s</div><div class="line"></div><div class="line">OK</div></div><!-- fragment --><h2>Triage</h2>
<p>The triage system is a separate executable, <code>triager.exe</code> that is run by the harness. It takes care of ranking exploitability, uniqueness, and binning of crashes.</p>
<h3>Exploitability</h3>
<p>The Exploitability ranking is a score for the potential ability to exploit a crash based on 3 engines. The ranks, ranging from High (4) to None (0), in order of likelyhood are:</p>
<ul>
<li><b>High</b> (4): The mostly likely case of a crash being exploitable.</li>
<li><b>Medium</b> (3): Between High and Low.</li>
<li><b>Low</b> (2): At or above the cutoff for low exploitability.</li>
<li><b>Unknown</b> (1): Unknown cases are below the cutoff for low, but still have the potential to be of interest.</li>
<li><b>None</b> (0): Very unlikely the crash is exploitable.</li>
</ul>
<h4>Engines</h4>
<ul>
<li><b>Google's Breakpad</b>: This engine uses Google's Breakpad library, which parses minidump files and return an exploitability between High and None as well.</li>
<li><b>Microsoft's <code>!exploitable</code></b>: A reimplementation and approxmiation of the <code>!exploitable</code> command for <code>windbg</code>, built on top of breakpad.</li>
<li><b>SL2 Tracer</b>: Uses the score from our own SL2 tracer, which takes taint information into consideration.</li>
</ul>
<h3>triage.json</h3>
<p>After the tracer has been run, <code>triager.exe</code> is run on the minidump file. It also loads any information generated by the tracer, and outputs the following json:</p>
<div class="fragment"><div class="line">{</div><div class="line">    <span class="comment">// This is the called functions before the crash</span></div><div class="line">    <span class="stringliteral">&quot;callStack&quot;</span>: [</div><div class="line">        140699242310037,</div><div class="line">        140718144357416,</div><div class="line">        140718144581792,</div><div class="line">        140718144447545</div><div class="line">    ],</div><div class="line"></div><div class="line">    <span class="comment">// The offending memory address</span></div><div class="line">    <span class="stringliteral">&quot;crashAddress&quot;</span>: 140699242310037,</div><div class="line"></div><div class="line">    <span class="comment">// The reason of exception type</span></div><div class="line">    <span class="stringliteral">&quot;crashReason&quot;</span>: <span class="stringliteral">&quot;EXCEPTION_BREAKPOINT&quot;</span>,</div><div class="line"></div><div class="line">    <span class="comment">// Exploitability from High to None</span></div><div class="line">    <span class="stringliteral">&quot;exploitability&quot;</span>: <span class="stringliteral">&quot;Unknown&quot;</span>,</div><div class="line"></div><div class="line">    <span class="comment">// The instruction pointer at the time of the crash</span></div><div class="line">    <span class="stringliteral">&quot;instructionPointer&quot;</span>: 14757395258967641292,</div><div class="line"></div><div class="line">    <span class="comment">// Path to the minidump analyzed</span></div><div class="line">    <span class="stringliteral">&quot;minidumpPath&quot;</span>: <span class="stringliteral">&quot;C:\\Users\\IEUser\\AppData\\Roaming\\Trail of Bits\\fuzzkit\\runs\\78f20c60-eb12-410a-8378-342c3afec986\\initial.dmp&quot;</span>,</div><div class="line"></div><div class="line">    <span class="comment">// Rank, or numeric version of exploitability from 0-4</span></div><div class="line">    <span class="stringliteral">&quot;rank&quot;</span>: 1,</div><div class="line"></div><div class="line">    <span class="comment">// The ranks generated by each of the 3 engines</span></div><div class="line">    <span class="stringliteral">&quot;ranks&quot;</span>: [</div><div class="line">        0,</div><div class="line">        0,</div><div class="line">        1</div><div class="line">    ],</div><div class="line"></div><div class="line">    <span class="comment">// A unique identifier for the crash. The algorithm uses 12 bits from the called functions,</span></div><div class="line">    <span class="comment">// and is unaffected by ASLR, function call order, or function call count</span></div><div class="line">    <span class="stringliteral">&quot;crashash&quot;</span>: <span class="stringliteral">&quot;f96808cfc4798256&quot;</span>,</div><div class="line"></div><div class="line">    <span class="comment">// Stack pointer at time of crash</span></div><div class="line">    <span class="stringliteral">&quot;stackPointer&quot;</span>: 14757395258967641292,</div><div class="line"></div><div class="line">    <span class="comment">// Unique tag for the crash for binning purposes</span></div><div class="line">    <span class="stringliteral">&quot;tag&quot;</span>: <span class="stringliteral">&quot;Unknown/EXCEPTION_BREAKPOINT/f96808cfc4798256&quot;</span>,</div><div class="line"></div><div class="line">    <span class="comment">// Complete output from the tracer run</span></div><div class="line">    <span class="stringliteral">&quot;tracer&quot;</span>: {</div><div class="line">        <span class="stringliteral">&quot;exception&quot;</span>: <span class="stringliteral">&quot;EXCEPTION_BREAKPOINT&quot;</span>,</div><div class="line">        <span class="stringliteral">&quot;instruction&quot;</span>: <span class="stringliteral">&quot;int3&quot;</span>,</div><div class="line">        <span class="stringliteral">&quot;last_calls&quot;</span>: [</div><div class="line">            140699242861232,</div><div class="line">            140699242861064,</div><div class="line">            140699242861064,</div><div class="line">            140699242861056,</div><div class="line">            140699242861184</div><div class="line">        ],</div><div class="line">        <span class="stringliteral">&quot;last_insns&quot;</span>: [</div><div class="line">            140699242309722,</div><div class="line">            140699242309725,</div><div class="line">            140699242309727,</div><div class="line">            140699242309730,</div><div class="line">            140699242310037</div><div class="line">        ],</div><div class="line">        <span class="stringliteral">&quot;location&quot;</span>: 140699242310037,</div><div class="line">        <span class="stringliteral">&quot;reason&quot;</span>: <span class="stringliteral">&quot;breakpoint&quot;</span>,</div><div class="line">        <span class="stringliteral">&quot;regs&quot;</span>: [</div><div class="line">            {</div><div class="line">                <span class="stringliteral">&quot;reg&quot;</span>: <span class="stringliteral">&quot;rax&quot;</span>,</div><div class="line">                <span class="stringliteral">&quot;tainted&quot;</span>: <span class="keyword">false</span>,</div><div class="line">                <span class="stringliteral">&quot;value&quot;</span>: 1080890113</div><div class="line">            },</div><div class="line">            <span class="comment">//...............................................</span></div><div class="line">        ],</div><div class="line">        <span class="stringliteral">&quot;score&quot;</span>: 25,</div><div class="line">        <span class="stringliteral">&quot;tainted_addrs&quot;</span>: [</div><div class="line">            {</div><div class="line">                <span class="stringliteral">&quot;size&quot;</span>: 8,</div><div class="line">                <span class="stringliteral">&quot;start&quot;</span>: 2645403054665</div><div class="line">            }</div><div class="line">        ]</div><div class="line">    }</div><div class="line">}</div></div><!-- fragment --><h2>File Formats</h2>
<h3>FKT Format</h3>
<p>This format is for recording mutation events for later replay.</p>
<p>&lsquo;char magic[4] == 'FKT&rsquo;`</p>
<p><code>uint type</code>, <code>1 == file</code></p>
<p>Variable based on type.</p>
<p><code>uint file_size</code></p>
<p><code>wchar_t path[file_size]</code></p>
<p><code>size_t position</code></p>
<p><code>size_t size</code></p>
<p><code>uchar data[size]</code></p>
<p>There's a 010 template for this in <code>misc</code></p>
<h3>Outdated components</h3>
<p>You can safely ignore most of the stuff in <code>corpus/asm</code> and <code>electriage</code></p>
<h1>Changes</h1>
<h2>20180808</h2>
<p>Changed passing of arguments to clients and target applications from using comma separated to just normally how it would appear on the command line. The <code>shlex.split()</code> function will split them up appropriately</p>
<h1>Developer Information</h1>
<p>If you change anything that would break backwards compatibility, increment <code>harness.config.VERSION</code>. This includes any database changes, formats, directory structures, filenames etc.. </p>
</div></div><!-- contents -->
<!-- start footer part -->
<hr class="footer"/><address class="footer"><small>
Generated by &#160;<a href="http://www.doxygen.org/index.html">
<img class="footer" src="doxygen.png" alt="doxygen"/>
</a> 1.8.14
</small></address>
</body>
</html>
